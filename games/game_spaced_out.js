var KEY_LEFT = 37;
var KEY_RIGHT = 39;
var KEY_SPACE = 32;
var KEY_P = 112;

var KEY_PAUSE = KEY_P;

var MS_PER_TICK = 10;

var prevTickMs = new Date().getTime();

var GAME_PAUSED = true;

  ///////////////////////////////////////////////////////////////////////////////////////////////////////////
  //window
  ///////////////////////////////////////////////////////////////////////////////////////////////////////////

var canvas = document.getElementById("gameCanvas");
var ctx = canvas.getContext("2d");
var padding = 10;

var width = 0;
var height = 0;

  ///////////////////////////////////////////////////////////////////////////////////////////////////////////
  //paddle
  ///////////////////////////////////////////////////////////////////////////////////////////////////////////

var paddleWidth = 0;
var paddleHeight = 0;

var paddleMinX = 0;
var paddleMaxX = 0;
var paddleSpeed = 0;

//center of the paddle
var paddleX = 0;
var paddleY = 0;

var paddleLeft = false;
var paddleRight = false;

  ///////////////////////////////////////////////////////////////////////////////////////////////////////////
  //balls
  ///////////////////////////////////////////////////////////////////////////////////////////////////////////

  

  ///////////////////////////////////////////////////////////////////////////////////////////////////////////
  //enemies
  ///////////////////////////////////////////////////////////////////////////////////////////////////////////

  ///////////////////////////////////////////////////////////////////////////////////////////////////////////
  //---
  ///////////////////////////////////////////////////////////////////////////////////////////////////////////

function resetCanvas() {
  var oldWidth = width;

  canvas.width = window.innerWidth - 10;
  canvas.height = window.innerHeight - 30;
  width = canvas.width - padding * 2;
  height = canvas.height - padding * 2;

  paddleWidth = width / 5;
  paddleMinX = paddleWidth / 2;
  paddleMaxX = width - paddleWidth / 2;
  paddleSpeed = width * 0.005;

  paddleHeight = height / 10;
  paddleY = height - paddleHeight / 2;

  paddleX *= width / oldWidth;

  GAME_PAUSED = true;
}

function resetGame() {
  paddleX = width / 2;
  paddleLeft = false;
  paddleRight = false;

  GAME_PAUSED = true;
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//helpers
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

//bounding box stuff

function boundingBox(x, y, dx, dy) {
  var ret = {x: x, y: y, dx: dx, dy: dy};
  ret.contains = contains.bind(ret, ret);
  ret.distance = distance.bind(ret, ret);
  return ret;
}

function contains(bb, x, y) {
  return x >= bb.x && x - bb.x < bb.dx && y >= bb.y && y - bb.y < bb.dy;
}

function distance(bb, x, y) {
  return 0; //TODO
}

//enemy stuff

function getEnemyImg(type) {
  return "enemy_" + type;
}

function getEnemy(bb, type, lives) {
  var enemy = {type: type || 1, lives: lives || 1, bb: bb, dead: false};
  enemy.onHit = enemyHitBasic.bind(enemy);
  return enemy;
}

function enemyHitBasic() {
  if(--this.lives <= 0) this.dead = true;
}

//

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//logic
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

//this is called from draw() to be continuous
function updateTick(part) {
  //resize

  //other stuff

  ///////////////////////////////////////////////////////////////////////////////////////////////////////////
  //move the paddle
  ///////////////////////////////////////////////////////////////////////////////////////////////////////////

  var paddleDx = 0;
  if(paddleLeft) paddleDx--;
  if(paddleRight) paddleDx++;
  paddleX += paddleDx * part * paddleSpeed;
  if(paddleX < paddleMinX) paddleX = paddleMinX;
  else if(paddleX > paddleMaxX) paddleX = paddleMaxX;
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//events
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

document.addEventListener("keydown", function(e) {
  if(e.keyCode == KEY_RIGHT) {
    paddleRight = true;
  }
  else if(e.keyCode == KEY_LEFT) {
    paddleLeft = true;
  }
}, false);

document.addEventListener("keyup", function(e) {
  if(e.keyCode == KEY_RIGHT) {
    paddleRight = false;
  }
  else if(e.keyCode == KEY_LEFT) {
    paddleLeft = false;
  }
}, false);

document.addEventListener("keypress", function(e) {
  if(e.keyCode == KEY_PAUSE) {
    GAME_PAUSED = !GAME_PAUSED;
  }
}, false);


////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//drawing
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

function drawPaddle(part) {
  var dx = paddleWidth / 2;
  var dy = paddleHeight / 2;
  ctx.beginPath();
  ctx.rect(paddleX - dx, paddleY - dy, paddleWidth, paddleHeight);
  ctx.fillStyle = "#ffffff";
  ctx.fill();
  ctx.strokeStyle = "#000000";
  ctx.lineWidth = 1;
  ctx.stroke();
  ctx.closePath();
}

//

var prevWindowWidth = window.innerWidth;
var prevWindowHeight = window.innerHeight;

function draw() {

  var ms = new Date().getTime();
  var part = (ms - prevTickMs) / MS_PER_TICK;

  //resize
  if(prevWindowWidth != window.innerWidth || prevWindowHeight != window.innerHeight) {
    prevWindowWidth = window.innerWidth;
    prevWindowHeight = window.innerHeight;
    resetCanvas();
  }

  if(!GAME_PAUSED) {
    updateTick(part);
  }

  ///////////////////////////////////////////////////////////////////////////////////////////////////////////
  //---
  ///////////////////////////////////////////////////////////////////////////////////////////////////////////

  ctx.setTransform(1, 0, 0, 1, 0, 0);
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.translate(padding, padding);
  //ctx.drawImage(document.getElementById('box'), 0, 0, width, height);

/*
  ctx.drawImage(document.getElementById('source'), 33, 71, 104, 124, 21, 20, 87, 104);
  ctx.transform(1,0.5,-0.5,1, 200, 0); //also has rotate() and translate()
  ctx.drawImage(document.getElementById('test'), 0, 0);

  ctx.setTransform(1, 0, 0, 1, 0, 0);
  ctx.translate(400, 100);
  ctx.drawImage(document.getElementById('box'), 0, 0, 20, 20);
  ctx.translate(0, 100);
  ctx.drawImage(document.getElementById('box'), 0, 0, 40, 40);
  ctx.translate(0, 100);
  ctx.drawImage(document.getElementById('box'), 0, 0, 80, 80);
  ctx.translate(0, 200);
  ctx.drawImage(document.getElementById('box'), 0, 0, 160, 160);
  ctx.setTransform(1, 0, 0, 1, 0, 0);
  ctx.translate(600, 100);
  ctx.drawImage(document.getElementById('box'), 0, 0, 256, 256);
  ctx.translate(0, 300);
  ctx.drawImage(document.getElementById('box'), 0, 0, 128, 128);
  ctx.setTransform(1, 0, 0, 1, 0, 0);
  ctx.translate(1000, 100);
  ctx.drawImage(document.getElementById('box'), 0, 0, 512, 512);
*/

  ctx.setTransform(1, 0, 0, 1, 0, 0);
  ctx.translate(padding, padding);

  drawPaddle(part);

  if(GAME_PAUSED) {
    ctx.font = '48px sans-serif';
    ctx.fillStyle = "#ffffff";
    ctx.textBaseline = 'top';
    ctx.fillText('Paused', 10, 10);
/*
    ctx.strokeStyle = "#ff0000";
    ctx.lineWidth = 2;
    ctx.strokeText('Pause', 10, 10);
*/
  }

  prevTickMs = ms;

  requestAnimationFrame(draw);
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//start game
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

resetCanvas();
resetGame();
draw();